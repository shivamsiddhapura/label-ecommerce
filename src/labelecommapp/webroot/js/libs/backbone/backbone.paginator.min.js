Backbone.Paginator=function(e,t,n){"use strict";var r={};r.version="<%= pkg.version %>";r.clientPager=e.Collection.extend({useDiacriticsPlugin:true,useLevenshteinPlugin:true,sortColumn:"",sortDirection:"desc",lastSortColumn:"",fieldFilterRules:[],lastFieldFilterRules:[],filterFields:"",filterExpression:"",lastFilterExpression:"",defaults_ui:{firstPage:0,currentPage:1,perPage:5,totalPages:10,pagesInRange:4},initialize:function(){this.on("add",this.addModel,this);this.on("remove",this.removeModel,this);this.setDefaults()},setDefaults:function(){var e=t.defaults(this.paginator_ui,this.defaults_ui);t.defaults(this,e)},addModel:function(e){this.origModels.push(e)},removeModel:function(e){var n=t.indexOf(this.origModels,e);this.origModels.splice(n,1)},sync:function(r,i,s){var o=this;this.setDefaults();var u={};t.each(t.result(o,"server_api"),function(e,n){if(t.isFunction(e)){e=t.bind(e,o);e=e()}u[n]=e});var a=t.clone(o.paginator_core);t.each(a,function(e,n){if(t.isFunction(e)){e=t.bind(e,o);e=e()}a[n]=e});a=t.defaults(a,{timeout:25e3,cache:false,type:"GET",dataType:"jsonp"});a=t.extend(a,{data:decodeURIComponent(n.param(u)),processData:false,url:t.result(a,"url")},s);var f=e.VERSION.split(".");var l=parseInt(f[0],10)===0&&parseInt(f[1],10)===9&&parseInt(f[2],10)<=9;var c=a.success;a.success=function(e,t,n){if(c){if(l){c(e,t,n)}else{c(i,e,a)}}if(i&&i.trigger){i.trigger("sync",i,e,a)}};var h=a.error;a.error=function(e){if(h){h(i,e,a)}if(i&&i.trigger){i.trigger("error",i,e,a)}};var p=a.xhr=n.ajax(a);if(i&&i.trigger){i.trigger("request",i,p,a)}return p},nextPage:function(e){if(this.currentPage<this.information.totalPages){this.currentPage=++this.currentPage;this.pager(e)}},previousPage:function(e){if(this.currentPage>1){this.currentPage=--this.currentPage;this.pager(e)}},goTo:function(e,t){if(e!==undefined){this.currentPage=parseInt(e,10);this.pager(t)}},howManyPer:function(e){if(e!==undefined){var t=this.perPage;this.perPage=parseInt(e,10);this.currentPage=Math.ceil((t*(this.currentPage-1)+1)/e);this.pager()}},setSort:function(e,t){if(e!==undefined&&t!==undefined){this.lastSortColumn=this.sortColumn;this.sortColumn=e;this.sortDirection=t;this.pager();this.info()}},setFieldFilter:function(e){if(!t.isEmpty(e)){this.lastFieldFilterRules=this.fieldFilterRules;this.fieldFilterRules=e;this.pager();this.info()}else{this.lastFieldFilterRules=this.fieldFilterRules;this.fieldFilterRules="";this.pager();this.info()}},doFakeFieldFilter:function(e){if(!t.isEmpty(e)){var n=this.origModels;if(n===undefined){n=this.models}n=this._fieldFilter(n,e);if(this.filterExpression!==""){n=this._filter(n,this.filterFields,this.filterExpression)}return n.length}},setFilter:function(e,t){if(e!==undefined&&t!==undefined){this.filterFields=e;this.lastFilterExpression=this.filterExpression;this.filterExpression=t;this.pager();this.info()}},doFakeFilter:function(e,n){if(e!==undefined&&n!==undefined){var r=this.origModels;if(r===undefined){r=this.models}if(!t.isEmpty(this.fieldFilterRules)){r=this._fieldFilter(r,this.fieldFilterRules)}r=this._filter(r,e,n);return r.length}},pager:function(e){var n=this,r=this.perPage,i=(n.currentPage-1)*r,s=i+r;if(n.origModels===undefined){n.origModels=n.models}n.models=n.origModels.slice();if(this.sortColumn!==""){n.models=n._sort(n.models,this.sortColumn,this.sortDirection)}if(!t.isEmpty(this.fieldFilterRules)){n.models=n._fieldFilter(n.models,this.fieldFilterRules)}if(this.filterExpression!==""){n.models=n._filter(n.models,this.filterFields,this.filterExpression)}if(this.lastSortColumn!==this.sortColumn||this.lastFilterExpression!==this.filterExpression||!t.isEqual(this.fieldFilterRules,this.lastFieldFilterRules)){i=0;s=i+r;n.currentPage=1;this.lastSortColumn=this.sortColumn;this.lastFieldFilterRules=this.fieldFilterRules;this.lastFilterExpression=this.filterExpression}n.sortedAndFilteredModels=n.models.slice();n.info();n.reset(n.models.slice(i,s));t.result(e,"success")},_sort:function(e,n,r){e=e.sort(function(e,i){var s=e.get(n),o=i.get(n);if(t.isUndefined(s)||t.isUndefined(o)){return 0}else{s=s.toString().toLowerCase();o=o.toString().toLowerCase()}if(r==="desc"){if(!s.match(/[^\-\d\.]/)&&s.match(/-?[\d\.]*/)&&!o.match(/[^\-\d\.]/)&&o.match(/-?[\d\.]*/)){if(s-0<o-0){return 1}if(s-0>o-0){return-1}}else{if(s<o){return 1}if(s>o){return-1}}}else{if(!s.match(/[^\-\d\.]/)&&s.match(/-?[\d\.]*/)&&!o.match(/[^\-\d\.]/)&&o.match(/-?[\d\.]*/)){if(s-0<o-0){return-1}if(s-0>o-0){return 1}}else{if(s<o){return-1}if(s>o){return 1}}}return 0});return e},_fieldFilter:function(e,n){if(t.isEmpty(n)){return e}var r=[];t.each(e,function(e){var i=true;t.each(n,function(n){if(!i){return false}i=false;if(n.type==="function"){var r=t.wrap(n.value,function(t){return t(e.get(n.field))});if(r()){i=true}}else if(n.type==="required"){if(!t.isEmpty(e.get(n.field).toString())){i=true}}else if(n.type==="min"){if(!t.isNaN(Number(e.get(n.field)))&&!t.isNaN(Number(n.value))&&Number(e.get(n.field))>=Number(n.value)){i=true}}else if(n.type==="max"){if(!t.isNaN(Number(e.get(n.field)))&&!t.isNaN(Number(n.value))&&Number(e.get(n.field))<=Number(n.value)){i=true}}else if(n.type==="range"){if(!t.isNaN(Number(e.get(n.field)))&&t.isObject(n.value)&&!t.isNaN(Number(n.value.min))&&!t.isNaN(Number(n.value.max))&&Number(e.get(n.field))>=Number(n.value.min)&&Number(e.get(n.field))<=Number(n.value.max)){i=true}}else if(n.type==="minLength"){if(e.get(n.field).toString().length>=n.value){i=true}}else if(n.type==="maxLength"){if(e.get(n.field).toString().length<=n.value){i=true}}else if(n.type==="rangeLength"){if(t.isObject(n.value)&&!t.isNaN(Number(n.value.min))&&!t.isNaN(Number(n.value.max))&&e.get(n.field).toString().length>=n.value.min&&e.get(n.field).toString().length<=n.value.max){i=true}}else if(n.type==="oneOf"){if(t.isArray(n.value)&&t.include(n.value,e.get(n.field))){i=true}}else if(n.type==="equalTo"){if(n.value===e.get(n.field)){i=true}}else if(n.type==="containsAllOf"){if(t.isArray(n.value)&&t.isArray(e.get(n.field))&&t.intersection(n.value,e.get(n.field)).length===n.value.length){i=true}}else if(n.type==="pattern"){if(e.get(n.field).toString().match(n.value)){i=true}}else{i=false}});if(i){r.push(e)}});return r},_filter:function(n,r,i){var s=this;var o={};if(t.isString(r)){o[r]={cmp_method:"regexp"}}else if(t.isArray(r)){t.each(r,function(e){o[e]={cmp_method:"regexp"}})}else{t.each(r,function(e,n){o[n]=t.defaults(e,{cmp_method:"regexp"})})}r=o;if(t.has(e.Paginator,"removeDiacritics")&&s.useDiacriticsPlugin){i=e.Paginator.removeDiacritics(i)}if(i===""||!t.isString(i)){return n}else{var u=t.map(i.match(/\w+/ig),function(e){return e.toLowerCase()});var a="("+t.uniq(u).join("|")+")";var f=new RegExp(a,"igm")}var l=[];t.each(n,function(n){var o=[];t.each(r,function(r,a){var l=n.get(a);if(l){var c=[];if(t.has(e.Paginator,"removeDiacritics")&&s.useDiacriticsPlugin){l=e.Paginator.removeDiacritics(l.toString())}else{l=l.toString()}if(r.cmp_method==="levenshtein"&&t.has(e.Paginator,"levenshtein")&&s.useLevenshteinPlugin){var h=e.Paginator.levenshtein(l,i);t.defaults(r,{max_distance:0});if(h<=r.max_distance){c=t.uniq(u)}}else{c=l.match(f)}c=t.map(c,function(e){return e.toString().toLowerCase()});t.each(c,function(e){o.push(e)})}});o=t.uniq(t.without(o,""));if(t.isEmpty(t.difference(u,o))){l.push(n)}});return l},info:function(){var e=this,t={},n=e.sortedAndFilteredModels?e.sortedAndFilteredModels.length:e.length,r=Math.ceil(n/e.perPage);t={totalUnfilteredRecords:e.origModels.length,totalRecords:n,currentPage:e.currentPage,perPage:this.perPage,totalPages:r,lastPage:r,previous:false,next:false,startRecord:n===0?0:(e.currentPage-1)*this.perPage+1,endRecord:Math.min(n,e.currentPage*this.perPage)};if(e.currentPage>1){t.previous=e.currentPage-1}if(e.currentPage<t.totalPages){t.next=e.currentPage+1}t.pageSet=e.setPagination(t);e.information=t;return t},setPagination:function(e){var t=[],n=0,r=0;var i=this.pagesInRange*2,s=Math.ceil(e.totalRecords/e.perPage);if(s>1){if(s<=1+i){for(n=1,r=s;n<=r;n++){t.push(n)}}else{if(e.currentPage<=this.pagesInRange+1){for(n=1,r=2+i;n<r;n++){t.push(n)}}else if(s-this.pagesInRange>e.currentPage&&e.currentPage>this.pagesInRange){for(n=e.currentPage-this.pagesInRange;n<=e.currentPage+this.pagesInRange;n++){t.push(n)}}else{for(n=s-i;n<=s;n++){t.push(n)}}}}return t},bootstrap:function(e){t.extend(this,e);this.goTo(1);this.info();return this}});r.clientPager.prototype.prevPage=r.clientPager.prototype.previousPage;r.requestPager=e.Collection.extend({sync:function(r,i,s){var o=this;o.setDefaults();var u={};t.each(t.result(o,"server_api"),function(e,n){if(t.isFunction(e)){e=t.bind(e,o);e=e()}u[n]=e});var a=t.clone(o.paginator_core);t.each(a,function(e,n){if(t.isFunction(e)){e=t.bind(e,o);e=e()}a[n]=e});a=t.defaults(a,{timeout:25e3,cache:false,type:"GET",dataType:"jsonp"});if(s.data){s.data=decodeURIComponent(n.param(t.extend(u,s.data)))}else{s.data=decodeURIComponent(n.param(u))}a=t.extend(a,{data:decodeURIComponent(n.param(u)),processData:false,url:t.result(a,"url")},s);var f=e.VERSION.split(".");var l=parseInt(f[0],10)===0&&parseInt(f[1],10)===9&&parseInt(f[2],10)<=9;var c=a.success;a.success=function(e,t,n){if(c){if(l){c(e,t,n)}else{c(i,e,a)}}if(i&&i.trigger){i.trigger("sync",i,e,a)}};var h=a.error;a.error=function(e){if(h){h(i,e,a)}if(i&&i.trigger){i.trigger("error",i,e,a)}};var p=a.xhr=n.ajax(a);if(i&&i.trigger){i.trigger("request",i,p,a)}return p},setDefaults:function(){var e=this;t.defaults(e.paginator_ui,{firstPage:0,currentPage:1,perPage:5,totalPages:10,pagesInRange:4});t.each(e.paginator_ui,function(n,r){if(t.isUndefined(e[r])){e[r]=e.paginator_ui[r]}})},requestNextPage:function(e){if(this.currentPage!==undefined){this.currentPage+=1;return this.pager(e)}else{var t=new n.Deferred;t.reject();return t.promise()}},requestPreviousPage:function(e){if(this.currentPage!==undefined){this.currentPage-=1;return this.pager(e)}else{var t=new n.Deferred;t.reject();return t.promise()}},updateOrder:function(e){if(e!==undefined){this.sortField=e;this.pager()}},goTo:function(e,t){if(e!==undefined){this.currentPage=parseInt(e,10);return this.pager(t)}else{var r=new n.Deferred;r.reject();return r.promise()}},howManyPer:function(e){if(e!==undefined){this.currentPage=this.firstPage;this.perPage=e;this.pager()}},info:function(){var e={totalRecords:this.totalRecords||0,currentPage:this.currentPage,firstPage:this.firstPage,totalPages:Math.ceil(this.totalRecords/this.perPage),lastPage:this.totalPages,perPage:this.perPage,previous:false,next:false};if(this.currentPage>1){e.previous=this.currentPage-1}if(this.currentPage<e.totalPages){e.next=this.currentPage+1}e.hasNext=e.next;e.hasPrevious=e.next;e.pageSet=this.setPagination(e);this.information=e;return e},setPagination:function(e){var t=[],n=0,r=0;var i=this.pagesInRange*2,s=Math.ceil(e.totalRecords/e.perPage);if(s>1){if(s<=1+i){for(n=1,r=s;n<=r;n++){t.push(n)}}else{if(e.currentPage<=this.pagesInRange+1){for(n=1,r=2+i;n<r;n++){t.push(n)}}else if(s-this.pagesInRange>e.currentPage&&e.currentPage>this.pagesInRange){for(n=e.currentPage-this.pagesInRange;n<=e.currentPage+this.pagesInRange;n++){t.push(n)}}else{for(n=s-i;n<=s;n++){t.push(n)}}}}return t},pager:function(e){if(!t.isObject(e)){e={}}return this.fetch(e)},url:function(){if(this.paginator_core!==undefined&&this.paginator_core.url!==undefined){return this.paginator_core.url}else{return null}},bootstrap:function(e){t.extend(this,e);this.setDefaults();this.info();return this}});r.requestPager.prototype.nextPage=r.requestPager.prototype.requestNextPage;r.requestPager.prototype.prevPage=r.requestPager.prototype.requestPreviousPage;return r}(Backbone,_,jQuery)